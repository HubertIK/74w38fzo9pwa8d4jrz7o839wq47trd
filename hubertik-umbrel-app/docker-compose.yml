version: '3.8'

services:
  anny-bot:
    image: node:20-bullseye
    container_name: anny-bot
    restart: unless-stopped
    user: root
    volumes:
      - /home/umbrel/umbrel/home/Documents/anny/backend:/usr/src/app
      - /home/umbrel/umbrel/home/Documents/anny/databases:/usr/src/app/databases
      - /usr/src/app/node_modules
    working_dir: /usr/src/app
    environment:
      - PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD=1
      - PLAYWRIGHT_CHROMIUM_EXECUTABLE_PATH=/usr/bin/chromium
      - DATA_DIR=/usr/src/app
      - USERS_DB_PATH=/usr/src/app/databases/users.db
      - RESOURCES_DB_PATH=/usr/src/app/databases/resources.db
      - JSON_DIR=/usr/src/app/json
      - JWT_DIR=/usr/src/app/jwt
      - TZ=Europe/Berlin
    command: >
      bash -c "
        echo 'ðŸš€ Starting Anny with Playwright...';
        if ! command -v chromium &> /dev/null; then
          echo 'ðŸ“¦ Installing Chromium for ARM64...';
          apt-get update -qq &&
          apt-get install -y -qq chromium fonts-liberation libnss3 libxss1 libappindicator3-1 libasound2 > /dev/null 2>&1 &&
          rm -rf /var/lib/apt/lists/* &&
          echo 'âœ… Chromium installed!';
        else
          echo 'âœ… Chromium ready';
        fi;
        if [ ! -d 'node_modules' ]; then
          echo 'ðŸ“¦ Installing npm packages...';
          npm install;
        else
          echo 'âœ… npm packages ready';
        fi;
        echo 'ðŸŽ¬ Starting scheduler...';
        exec node scheduler.js
      "
    networks:
      - anny_network

  anny-frontend:
    image: node:18
    container_name: anny-frontend
    restart: unless-stopped
    volumes:
      - /home/umbrel/umbrel/home/Documents/anny/frontend:/usr/src/app
      - /home/umbrel/umbrel/home/Documents/anny/databases:/usr/src/app/databases
      - /home/umbrel/umbrel/home/Documents/anny/backend/json:/usr/src/app/json
      - /usr/src/app/node_modules
    working_dir: /usr/src/app
    environment:
      - USERS_DB_PATH=/usr/src/app/databases/users.db
      - RESOURCES_DB_PATH=/usr/src/app/databases/resources.db
      - JSON_DIR=/usr/src/app/json
      - TZ=Europe/Berlin
    command: sh -c "npm install && node app.js"
    networks:
      - anny_network
    ports:
      - "3001:3000"

  app_proxy:
    environment:
      APP_HOST: anny-frontend
      APP_PORT: "3000"
    networks:
      - anny_network

networks:
  anny_network:
    driver: bridge
